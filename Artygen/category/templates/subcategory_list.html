<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Subcategory List</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #ffffff;
        color: #4a4a4a;
      }

      h1 {
        color: #d4af37;
      }

      .card {
        background-color: #f8f9fa;
        border: none;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: 0.3s ease-in-out;
        border-radius: 10px;
      }

      .card:hover {
        transform: translateY(-5px);
      }

      .btn {
        font-size: 0.8rem;
        border-radius: 5px;
        transition: background-color 0.3s, transform 0.2s;
        padding: 0.4rem 0.8rem;
        display: flex;
        align-items: center;
      }

      .btn i {
        margin-right: 8px;
        font-size: 1rem;
      }

      .btn-primary {
        background-color: transparent;
        color: #d4af37;
        border: 1px solid #d4af37;
      }

      .btn-primary:hover {
        background-color: #d4af37;
        color: white;
        transform: translateY(-2px);
      }

      .btn-warning,
      .btn-danger,
      .btn-info {
        background-color: transparent;
        border: 1px solid;
      }

      .btn-warning:hover,
      .btn-danger:hover,
      .btn-info:hover {
        color: white;
        transform: translateY(-2px);
      }

      .btn-warning {
        color: #f39c12;
        border-color: #f39c12;
      }

      .btn-danger {
        color: #e74c3c;
        border-color: #e74c3c;
      }

      .btn-info {
        color: #3498db;
        border-color: #3498db;
      }

      .card-title,
      .card-text {
        color: #4a4a4a;
      }

      .custom-btn-width {
        display: inline-block;
        width: auto;
      }

      .generated-list {
        margin-top: 20px;
      }

      .subcategory-card {
        margin-bottom: 15px; /* Space between subcategory cards */
        transition: all 0.3s ease;
      }

      .subcategory-card:hover {
        transform: translateY(-2px);
      }

      .form-check-input:checked ~ .card {
        border-color: #ffc107;
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
      }
    </style>
  </head>
  <body>
    {% include './navbar.html' %}

    <div class="container mt-4">
      <h1 class="text-center my-4">Subcategories for {{ category.name }}</h1>
      <a href="{% url 'category-list'  %}" class="btn custom-btn btn-cancel">
        <i class="fas fa-arrow-left"></i> Back to Categories
      </a>

      <div class="btn-container mb-4">
        <a
          href="{% url 'subcategory-create' category.id %}"
          class="btn btn-primary custom-btn-width"
        >
          <i class="fas fa-plus-circle"></i> Add New Subcategory
        </a>
        <button
          id="generateSubcategories"
          class="btn btn-info custom-btn-width"
        >
          <i class="fas fa-magic"></i> Generate Subcategories with AI
        </button>
        <button
          id="editSelectedBtn"
          class="btn btn-warning custom-btn-width"
          style="display: none;"
          onclick="editSelected()"
        >
          <i class="fas fa-edit"></i> Edit Selected (<span id="selectedCount">0</span>)
        </button>
        <button
          id="deleteSelectedBtn"
          class="btn btn-danger custom-btn-width"
          style="display: none;"
          onclick="deleteSelected()"
        >
          <i class="fas fa-trash"></i> Delete Selected
        </button>
      </div>

      <div class="row g-3">
        {% for subcategory in subcategories %}
        <div class="col-md-4 col-sm-6">
          <div class="card h-100 subcategory-card" data-subcategory-id="{{ subcategory.pk }}">
            <div class="card-body d-flex flex-column p-3">
              <div class="form-check mb-2">
                <input 
                  class="form-check-input subcategory-checkbox" 
                  type="checkbox" 
                  value="{{ subcategory.pk }}"
                  data-name="{{ subcategory.name }}"
                  data-description="{{ subcategory.description }}"
                  onchange="updateSelectionButtons()"
                >
                <label class="form-check-label" style="font-weight: bold; color: #666;">
                  Sélectionner
                </label>
              </div>
              <h5 class="card-title">{{ subcategory.name }}</h5>
              <p class="card-text">{{ subcategory.description }}</p>
              <div class="mt-auto d-flex justify-content-between">
                <a
                  href="{% url 'subcategory-update' category.id subcategory.pk %}"
                  class="btn btn-warning btn-sm"
                >
                  <i class="fas fa-edit"></i> Edit
                </a>
                <a
                  href="{% url 'subcategory-delete' category.id subcategory.pk %}"
                  class="btn btn-danger btn-sm"
                >
                  <i class="fas fa-trash-alt"></i> Delete
                </a>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <hr style="border: none; border-top: 2px solid gray; margin: 20px 0" />

      <div id="subcategoriesResponse" class="mt-4 generated-list"></div>

      {% if error_message %}
      <div class="alert alert-danger mt-3">{{ error_message }}</div>
      {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
<script>
  document
    .getElementById('generateSubcategories')
    .addEventListener('click', function () {
      const categoryId = '{{ category.id }}' // Get the current category ID
      const url = `/category/categories/${categoryId}/subcategories/get_art_subcategories/` // Construct the URL
      
      // Afficher un message de chargement
      const subcategoriesResponse = document.getElementById('subcategoriesResponse')
      subcategoriesResponse.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Génération des sous-catégories en cours...</div>'

      fetch(url, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error(
              'Network response was not ok ' + response.statusText
            )
          }
          return response.json()
        })
        .then((data) => {
          subcategoriesResponse.innerHTML = '' // Clear previous responses

          if (data.error) {
            subcategoriesResponse.innerHTML = `<div class="alert alert-danger">${data.error}</div>`
            return
          }

          if (data.subcategories && data.subcategories.length > 0) {
            // Afficher le titre
            const title = document.createElement('h4')
            title.textContent = 'Voici 5 souscatégories pour la catégorie artistique "{{ category.name }}" avec leur description'
            title.classList.add('mb-3', 'text-center')
            subcategoriesResponse.appendChild(title)

            const cardContainer = document.createElement('div')
            cardContainer.classList.add('row', 'g-3', 'generated-list')

            data.subcategories.forEach((item) => {
              const colDiv = document.createElement('div')
              colDiv.classList.add('col-md-4', 'subcategory-card')

              const card = document.createElement('div')
              card.classList.add('card', 'h-100')

              const cardBody = document.createElement('div')
              cardBody.classList.add('card-body', 'd-flex', 'flex-column', 'p-3')

              const title = document.createElement('h5')
              title.classList.add('card-title')
              title.textContent = item.subcategory

              const description = document.createElement('p')
              description.classList.add('card-text', 'flex-grow-1')
              description.textContent = item.description

              // Bouton pour ajouter la sous-catégorie
              const addButton = document.createElement('button')
              addButton.classList.add('btn', 'btn-success', 'btn-sm', 'mt-2')
              addButton.innerHTML = '<i class="fas fa-plus"></i> Ajouter'
              addButton.onclick = function() {
                addSubcategory(item.subcategory, item.description, categoryId, addButton)
              }

              cardBody.appendChild(title)
              cardBody.appendChild(description)
              cardBody.appendChild(addButton)
              card.appendChild(cardBody)
              colDiv.appendChild(card)
              cardContainer.appendChild(colDiv)
            })

            subcategoriesResponse.appendChild(cardContainer)
          } else {
            subcategoriesResponse.innerHTML =
              '<div class="alert alert-warning">Aucune sous-catégorie générée.</div>'
          }
        })
        .catch((error) => {
          console.error('There was a problem with the fetch operation:', error)
          subcategoriesResponse.innerHTML = `<div class="alert alert-danger">Erreur: ${error.message}</div>`
        })
    })

  // Fonction pour ajouter une sous-catégorie
  function addSubcategory(name, description, categoryId, button) {
    const url = `/category/categories/${categoryId}/subcategories/create/`
    
    // Désactiver le bouton pendant l'ajout
    button.disabled = true
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ajout...'

    // Créer un formulaire FormData
    const formData = new FormData()
    formData.append('name', name)
    formData.append('description', description)
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}')

    fetch(url, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json'
      }
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // Succès - recharger la page pour afficher la nouvelle sous-catégorie
          button.innerHTML = '<i class="fas fa-check"></i> Ajoutée!'
          button.classList.remove('btn-success')
          button.classList.add('btn-secondary')
          
          // Recharger la page après 1 seconde
          setTimeout(() => {
            location.reload()
          }, 1000)
        } else {
          throw new Error(data.error || 'Erreur lors de l\'ajout')
        }
      })
      .catch((error) => {
        console.error('Error:', error)
        alert('Erreur: ' + error.message)
        button.disabled = false
        button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erreur'
        button.classList.remove('btn-success')
        button.classList.add('btn-danger')
      })
  }

  // Fonction pour mettre à jour l'affichage des boutons de sélection
  function updateSelectionButtons() {
    const checkboxes = document.querySelectorAll('.subcategory-checkbox:checked')
    const count = checkboxes.length
    const editBtn = document.getElementById('editSelectedBtn')
    const deleteBtn = document.getElementById('deleteSelectedBtn')
    const countSpan = document.getElementById('selectedCount')
    
    if (count > 0) {
      editBtn.style.display = 'inline-block'
      deleteBtn.style.display = 'inline-block'
      countSpan.textContent = count
    } else {
      editBtn.style.display = 'none'
      deleteBtn.style.display = 'none'
    }

    // Ajouter un style visuel aux cartes sélectionnées
    document.querySelectorAll('.subcategory-card').forEach(card => {
      const checkbox = card.querySelector('.subcategory-checkbox')
      if (checkbox && checkbox.checked) {
        card.style.border = '2px solid #ffc107'
        card.style.boxShadow = '0 4px 12px rgba(255, 193, 7, 0.3)'
      } else {
        card.style.border = ''
        card.style.boxShadow = ''
      }
    })
  }

  // Fonction pour éditer les sous-catégories sélectionnées
  function editSelected() {
    const checkboxes = document.querySelectorAll('.subcategory-checkbox:checked')
    const categoryId = '{{ category.id }}'
    
    if (checkboxes.length === 1) {
      // Si une seule sous-catégorie est sélectionnée, rediriger vers la page d'édition normale
      const subcategoryId = checkboxes[0].value
      window.location.href = `/category/categories/${categoryId}/subcategories/${subcategoryId}/update/`
    } else if (checkboxes.length > 1) {
      // Si plusieurs sous-catégories sont sélectionnées, ouvrir un modal ou une interface d'édition groupée
      const subcategoryIds = Array.from(checkboxes).map(cb => cb.value)
      editMultiple(subcategoryIds, categoryId)
    }
  }

  // Fonction pour éditer plusieurs sous-catégories à la fois
  function editMultiple(subcategoryIds, categoryId) {
    // Récupérer les données de la première sous-catégorie comme exemple
    const firstCheckbox = document.querySelector('.subcategory-checkbox:checked')
    const firstName = firstCheckbox.dataset.name
    const firstDescription = firstCheckbox.dataset.description

    // Créer un modal d'édition groupée
    const modalHtml = `
      <div class="modal fade" id="bulkEditModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Éditer ${subcategoryIds.length} sous-catégories</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <p class="text-muted">Les modifications seront appliquées à toutes les sous-catégories sélectionnées.</p>
              <div class="mb-3">
                <label for="bulkName" class="form-label">Nom (laissez vide pour ne pas modifier)</label>
                <input type="text" class="form-control" id="bulkName" placeholder="Nouveau nom commun">
              </div>
              <div class="mb-3">
                <label for="bulkDescription" class="form-label">Description (laissez vide pour ne pas modifier)</label>
                <textarea class="form-control" id="bulkDescription" rows="4" placeholder="Nouvelle description commune"></textarea>
              </div>
              <div class="alert alert-info">
                <strong>Note:</strong> Vous pouvez aussi éditer chaque sous-catégorie individuellement ci-dessous:
              </div>
              <div id="individualEdits"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
              <button type="button" class="btn btn-primary" onclick="saveBulkEdit()">Sauvegarder</button>
            </div>
          </div>
        </div>
      </div>
    `
    
    // Supprimer le modal s'il existe déjà
    const existingModal = document.getElementById('bulkEditModal')
    if (existingModal) {
      existingModal.remove()
    }
    
    // Ajouter le modal au body
    document.body.insertAdjacentHTML('beforeend', modalHtml)
    
    // Ajouter les champs individuels
    const individualEditsDiv = document.getElementById('individualEdits')
    subcategoryIds.forEach(id => {
      const checkbox = document.querySelector(`.subcategory-checkbox[value="${id}"]`)
      const name = checkbox.dataset.name
      const description = checkbox.dataset.description
      
      individualEditsDiv.innerHTML += `
        <div class="card mb-2">
          <div class="card-body">
            <h6 class="card-title">${name}</h6>
            <div class="mb-2">
              <label class="form-label">Nom</label>
              <input type="text" class="form-control individual-name" data-id="${id}" value="${name}">
            </div>
            <div>
              <label class="form-label">Description</label>
              <textarea class="form-control individual-description" data-id="${id}" rows="2">${description}</textarea>
            </div>
          </div>
        </div>
      `
    })
    
    // Afficher le modal
    const modal = new bootstrap.Modal(document.getElementById('bulkEditModal'))
    modal.show()
    
    // Stocker les IDs dans une variable globale pour y accéder dans saveBulkEdit
    window.editingSubcategoryIds = subcategoryIds
    window.editingCategoryId = categoryId
  }

  // Fonction pour sauvegarder les modifications groupées
  function saveBulkEdit() {
    const bulkName = document.getElementById('bulkName').value
    const bulkDescription = document.getElementById('bulkDescription').value
    const categoryId = window.editingCategoryId
    
    // Récupérer les modifications individuelles
    const updates = []
    window.editingSubcategoryIds.forEach(id => {
      const nameInput = document.querySelector(`.individual-name[data-id="${id}"]`)
      const descInput = document.querySelector(`.individual-description[data-id="${id}"]`)
      
      updates.push({
        id: id,
        name: bulkName || nameInput.value,
        description: bulkDescription || descInput.value
      })
    })
    
    // Envoyer les mises à jour
    const promises = updates.map(update => {
      const formData = new FormData()
      formData.append('name', update.name)
      formData.append('description', update.description)
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}')
      
      return fetch(`/category/categories/${categoryId}/subcategories/${update.id}/update/`, {
        method: 'POST',
        body: formData
      })
    })
    
    Promise.all(promises)
      .then(responses => {
        // Fermer le modal
        bootstrap.Modal.getInstance(document.getElementById('bulkEditModal')).hide()
        // Recharger la page
        location.reload()
      })
      .catch(error => {
        console.error('Error:', error)
        alert('Erreur lors de la mise à jour')
      })
  }

  // Fonction pour supprimer les sous-catégories sélectionnées
  function deleteSelected() {
    const checkboxes = document.querySelectorAll('.subcategory-checkbox:checked')
    const count = checkboxes.length
    
    if (confirm(`Êtes-vous sûr de vouloir supprimer ${count} sous-catégorie(s) ?`)) {
      const categoryId = '{{ category.id }}'
      const promises = Array.from(checkboxes).map(checkbox => {
        const subcategoryId = checkbox.value
        return fetch(`/category/categories/${categoryId}/subcategories/${subcategoryId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        })
      })
      
      Promise.all(promises)
        .then(() => {
          location.reload()
        })
        .catch(error => {
          console.error('Error:', error)
          alert('Erreur lors de la suppression')
        })
    }
  }
</script>
